
<script src="/static/lib/jexcel/2.0.2/jquery.jexcel.js"></script>
<link rel="stylesheet" href="/static/lib/jexcel/2.0.2/jquery.jexcel.min.css" type="text/css" />

<!--
<script src="/static/lib/jexcel/2.0.2/jquery.jdropdown.js"></script>
<script src="/static/lib/jexcel/2.0.2/jquery.jcalendar.js"></script>
<link rel="stylesheet" href="/static/lib/jexcel/2.0.2/jquery.jdropdown.min.css" type="text/css" />
<link rel="stylesheet" href="/static/lib/jexcel/2.0.2/jquery.jcalendar.min.css" type="text/css" />
-->

<style type="text/css">
/** 用于编辑时的换行 **/
.jexcel .editor {
    white-space: pre-wrap;
}
.jexcel td {
    word-break: break-all;
}
#myParent {
    margin-top: 5px;
    width: 100%;
}
</style>

{% set item = file %}

<div class="card">
    <div class="grid-title btn-line-height">
        <span>表格查看</span>
        {% if _user_name == file.creator %} 
            <div class="float-right">
                <button class="btn" id="saveBtn">保存</button>
                {% include note/component/option/note_dropdown.html %}
                {% include common/button/back_button.html %}
            </div>
        {% end %}
    </div>
</div>

<div class="card">
    {% include note/component/note_path.html %}
</div>

<div class="card">
    <textarea id="content" class="hide">{{file.content}}</textarea>
    <div id="myParent" class="row">
        <div id="my"></div>
    </div>
</div>

<script type="text/javascript">

$(function () {
    var content = $("#content").val();
    var rows  = CSV.parse(content);

    if (rows.length == 0) {
        rows = [
            ['A', 'B', 'C', 'D', 'E'],
            ['', '', '', '', '']
        ];
    }

    var head = rows[0];
    var data = rows.slice(1);
    var columns = [];
    var colWidths = [];

    var width = ($("#myParent").width() - 35) / head.length;
    width = Math.max(width, 50);
    
    head.forEach(function () {
        columns.push({type: "text"});
    });

    head.forEach(function () {
        colWidths.push(width);
    });

    var excel = $('#my').jexcel({
        // csv: $("#content").val(),
        data: data,
        colHeaders: head,
        colWidths: colWidths,
        columns: columns,
        wordWrap: true,
        columnSorting: false
    });

    $("#saveBtn").click(function () {
        var head = $("#my").jexcel("getHeaders");
        var data = $("#my").jexcel('getData');
        data.splice(0, 0, head);
        var csvData = CSV.encode(data);
        console.log(csvData);
        $.post("/note/save?type=csv", {id:"{{file.id}}", version:{{file.version}}, content:csvData}, function (resp) {
            console.log(resp);
            if (resp.code == "success") {
                // window.location.reload();
                window.location.href = "/note/view?id={{file.id}}";
            } else {
                alert(resp.message);
            }
        })
    });

    $("body").on("click", ".edition", function (e) {
        console.log(e.target);
    });
});
</script>
</html>